name: Release

# üöÄ–°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –ø—É—à–∏—Ç—Å—è –Ω–æ–≤—ã–π —Ç—ç–≥-–≤–µ—Ä—Å–∏—è.
#    –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —Ç—ç–≥–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –æ—Ç –∫–æ–º–º–∏—Ç–æ–≤ –≤–µ—Ç–∫–∏ main
#    (–æ–±—ã—á–Ω–æ git tag v1.2.3 && git push origin main --follow-tags).

on:
  push:
    tags:
      - 'v*'            # –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —É–∂–µ—Å—Ç–æ—á–∏—Ç–µ —à–∞–±–ª–æ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä v[0-9]*.[0-9]*.[0-9]*)

jobs:
  test-and-release:
    runs-on: ubuntu-latest

    steps:
      # 1 ‚Äî –∫–æ–¥
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0      # –Ω—É–∂–µ–Ω –ø–æ–ª–Ω—ã–π git history, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç—ç–≥

      # 3 ‚Äî –≤—ã—á–∏—Å–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç—ç–≥
      - name: Detect tags
        id: tags
        run: |
          # —Ç–µ–∫—É—â–∏–π —Ç—ç–≥ –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ GITHUB_REF –≤–∏–¥–∞ refs/tags/v1.2.3
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          echo "tag=$TAG_NAME"   >>"$GITHUB_OUTPUT"

          # –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç—ç–≥ (‚üÇ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç ‚Äî –≤—ã–≤–æ–¥ –±—É–¥–µ—Ç –ø—É—Å—Ç—ã–º)
          PREV_TAG="$(git describe --tags --abbrev=0 "$(git rev-list --tags --skip=1 --max-count=1)")"
          echo "prev=$PREV_TAG"  >>"$GITHUB_OUTPUT"

      # 4 ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–º–º–∏—Ç–æ–≤ –º–µ–∂–¥—É —Ç—ç–≥–∞–º–∏
      - name: Build changelog
        id: changelog
        run: |
          {
            echo 'text<<EOF'
            if [ -n "${{ steps.tags.outputs.prev }}" ]; then
              git log --pretty=format:'- %s' "${{ steps.tags.outputs.prev }}..${{ steps.tags.outputs.tag }}"
            else
              git log --pretty=format:'- %s' "${{ steps.tags.outputs.tag }}"
            fi
            echo 'EOF'
          } >>"$GITHUB_OUTPUT"

      # 5 ‚Äî —Å–æ–∑–¥–∞—ë–º —Ä–µ–ª–∏–∑
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name:  ${{ steps.tags.outputs.tag }}
          name:      ${{ steps.tags.outputs.tag }}           # –∏–º—è —Ä–µ–ª–∏–∑–∞ = —Ç—ç–≥
          body:      ${{ steps.changelog.outputs.text }}     # –æ–ø–∏—Å–∞–Ω–∏–µ = —Å–ø–∏—Å–æ–∫ –∫–æ–º–º–∏—Ç–æ–≤
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
